(()=>{"use strict";let e="";function t(t){game.socket.emit(`module.${e}`,t)}function n(...t){return`${e}.settings.${t.join(".")}`}function a(...t){return`flags.${e}.${t.join("/")}`}function i(...t){return t=t.filter((e=>"string"==typeof e)),`modules/${e}/templates/${t.join("/")}`}function r(t){return game.settings.get(e,t)}function o(t){const a=t.name;t.scope=t.scope??"world",t.config=t.config??!1,t.config&&(t.name=n(a,"name"),t.hint=n(a,"hint")),Array.isArray(t.choices)&&(t.choices=t.choices.reduce(((e,t)=>(e[t]=n(a,"choices",t),e)),{})),game.settings.register(e,a,t)}function c(t,n,a){return t.getFlag(e,n)??a}function s(t,n,a){return t.setFlag(e,n,a)}function d(e,t,n,a){const i="string"==typeof t?t:"info",r="object"==typeof t?t:"object"==typeof n?n:void 0,o="boolean"==typeof t?t:"boolean"==typeof n?n:a??!1;ui.notifications.notify(p(e,r),i,{permanent:o})}function u(...e){const[t,n,a]=e;d(t,"warning",n,a)}function l(...e){const[t,n,a]=e;d(t,"info",n,a)}function f(...e){const[t,n,a]=e;d(t,"error",n,a)}function p(...t){let[n,a]=t;return n=`${e}.${n}`,a?game.i18n.format(n,a):game.i18n.localize(n)}function g(t){const n=(...e)=>p(`${t}.${e[0]}`,e[1]);return Object.defineProperties(n,{warn:{value:(...e)=>u(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},info:{value:(...e)=>l(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},error:{value:(...e)=>f(`${t}.${e[0]}`,e[1],e[2]),enumerable:!1,configurable:!1},has:{value:n=>function(t){return game.i18n.has(`${e}.${t}`,!1)}(`${t}.${n}`),enumerable:!1,configurable:!1},path:{value:n=>function(t){return`${e}.${t}`}(`${t}.${n}`),enumerable:!1,configurable:!1}}),n}function h(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}const m="pf2e.hero-point-deck",v="Compendium.pf2e.rollable-tables.zgZoI7h0XjjJrrNK",b="systems/pf2e/icons/features/feats/heroic-recovery.webp";async function y(e){if(!e)return;const t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}async function w(){return game.tables.find((e=>e.getFlag("core","sourceId")===v))}function k(e){const t=c(e,"heroActions")??[],n=game.packs.get(m);return t.map((e=>{if("string"!=typeof e)return e;if(!n)return;const t=n.index.get(e);return t?{name:t.name,uuid:`Compendium.${m}.${t._id}`}:void 0})).filter((e=>e))}async function T(e,t){const n=e.heroPoints.value;if(n<1)return u("use.noPoints");const i=k(e),r=i.findIndex((e=>e.uuid===t));if(-1===r)return;const o=await A(t);o||f("use.noDetails"),i.splice(r,1),o?(e.update({"system.resources.heroPoints.value":n-1,[a("heroActions")]:i}),ChatMessage.create({flavor:`<h4 class="action">${p("actions-use.header")}</h4>`,content:`<h2>${o.name}</h2>${o.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):s(e,"heroActions",i)}async function A(e){const t=await fromUuid(e);if(!(t instanceof JournalEntry))return;const n=t.pages.contents[0];let a=n?.text.content;return a&&t.pack===m&&(a=a.replace(/^<p>/,"<p><strong>Trigger</strong> ")),a?{name:t.name,description:a}:void 0}function C(e,t){return s(e,"heroActions",t)}function D(e=!0,t){const n={name:p("table.name"),replacement:!e,img:b,description:p("table.description")};return t?mergeObject(duplicate(t._source),n):n}async function U(){const e=await async function(){return await async function(){return y(r("tableUUID"))}()??await w()??await async function(){return y(v)}()}();if(!e)return f("table.drawError",!0),null;if(!e.formula){if(!game.user.isGM)return f("table.noFormula",!0),null;if(e.compendium)return f("table.noFormulaCompendium",!0),null;await e.normalize()}e.replacement&&(e.results.filter((e=>!e.drawn)).length||await e.resetResults());const t=(await e.draw({displayChat:!1})).results[0];if(!t)return;const n=(a=t).type===CONST.TABLE_RESULT_TYPES.DOCUMENT?`${a.documentCollection}.${a.documentId}`:a.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM?`Compendium.${a.documentCollection}.${a.documentId}`:void 0;var a;return n?{uuid:n,name:t.text}:void 0}const M=g("templates.createTable.choice"),I=g("templates.createTable.default.confirm"),S=g("templates.removeActions");async function j(){const e=i("dialogs/remove-actions.hbs"),t={yes:{label:S("remove"),icon:'<i class="fas fa-trash"></i>',callback:e=>e.find('input[name="actor"]:checked').toArray().map((e=>game.actors.get(e.value))).filter((e=>e))},no:{label:S("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>[]}},n={content:await renderTemplate(e,{actors:game.actors.filter((e=>"character"===e.type)),i18n:S}),title:S("title"),buttons:t,default:"yes",render:e=>{e.on("change",'input[name="all"]',(()=>function(e){const t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}(e))),e.on("change",'input[name="actor"]',(()=>function(e){const t=e.find('input[name="actor"]'),n=t.filter(":checked"),a=e.find('input[name="all"]');t.length===n.length?(a.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?a.prop("checked",!1).prop("indeterminate",!0):(a.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}(e)))},close:()=>[]},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-remove-actions"});if(!a.length)return u("templates.removeActions.noSelection");for(const e of a)await s(e,"heroActions",[]);l("templates.removeActions.removed")}async function E(){const e=i("dialogs/create-table.hbs"),t={yes:{label:M("create"),icon:'<i class="fas fa-border-all"></i>',callback:e=>({type:e.find('.window-content input[name="type"]:checked').val(),unique:"unique"===e.find('.window-content input[name="draw"]:checked').val()})},no:{label:M("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},n={content:await renderTemplate(e,{i18n:M}),title:M("title"),buttons:t,default:"yes",close:()=>null},a=await Dialog.wait(n,void 0,{id:"pf2e-hero-actions-create-table"});a&&("default"===a.type?async function(e){let t=await w();if(t&&await Dialog.confirm({title:I("title"),content:I("content")})){const n=D(e);return await t.update(n),O(t,!0)}t=await async function(e=!0){const t=D(e,await fromUuid(v));return RollTable.create(t,{temporary:!1})}(e),await O(t)}(a.unique):async function(e){const t=await function(e=!0){const t=D(e);return RollTable.create(t,{temporary:!1})}(e);await O(t),t.sheet?.render(!0)}(a.unique))}async function O(t,n=!1){var a;n&&await t.normalize(),await("tableUUID",a=t.uuid,game.settings.set(e,"tableUUID",a))}async function P(e){const{sender:t,receiver:n}=e,a=game.actors.get(t.cid),i=game.actors.get(n.cid);if(!a||!i)return void H(e);const r=c(a,"heroActions")??[],o=c(i,"heroActions")??[],d=r.findIndex((e=>e.uuid===t.uuid)),u=o.findIndex((e=>e.uuid===n.uuid));if(-1===d||-1===u)return void H(e);const l=r.splice(d,1)[0],f=o.splice(u,1)[0];r.push(f),o.push(l),s(a,"heroActions",r),s(i,"heroActions",o);let g=`<div>${p("trade-success.offer",{offer:h(l.uuid)})}</div>`;g+=`<div>${p("trade-success.receive",{receive:h(f.uuid)})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${p("trade-success.header",{name:i.name})}</h4>`,content:g,speaker:ChatMessage.getSpeaker({actor:a})})}async function _({receiver:e}){u("trade-rejected",{name:game.actors.get(e.cid).name},!0)}function x(e){f("trade-error")}function q(e){game.user.isGM?P(e):t({...e,type:"trade-accept"})}function H({sender:e,receiver:n},a="trade-error"){const i=new Set([e.id,n.id]);i.has(game.user.id)&&(i.delete(game.user.id),x()),i.size&&t({type:"trade-error",users:Array.from(i),error:a})}class Trade extends Application{_actor;_target;constructor(e){super({id:`pf2e-hero-actions-trade-${e.id}`}),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:p("templates.trade.title"),template:i("trade.hbs"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(e){e?e!==this._target&&(delete this.target?.apps?.[this.appId],this._target=e,this.render()):f("templates.trade.no-target")}getData(e){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter((e=>"character"===e.type&&e.id!==this.actor.id&&e.hasPlayerOwner)),actions:k(this.actor),targetActions:this.target?k(this.target):[],i18n:g("templates.trade")})}activateListeners(e){super.activateListeners(e),e.find('select[name="target"]').on("change",this.#e.bind(this)),e.find('[data-action="description"]').on("click",this.#t.bind(this)),e.find('[data-action="trade"]').on("click",this.#n.bind(this)),e.find('[data-action="cancel"]').on("click",(()=>this.close()))}render(e,t){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(e,t)}async close(e){await super.close(e),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#n(){if(!this.target)return void u("templates.trade.no-target");const e=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if("string"!=typeof e||"string"!=typeof n)return void u("templates.trade.no-select");let a=function(e,t=!1){return t?game.users.find((t=>t.active&&t.character===e)):game.users.find((t=>t.character===e))}(this.target,!0)??function(e,t=!1){return t?game.users.find((t=>t.active&&e.testUserPermission(t,"OWNER"))):game.users.find((t=>e.testUserPermission(t,"OWNER")))}(this.target,!0)??game.users.find((e=>e.active&&e.isGM));var i;a?((i={sender:{id:game.user.id,cid:this.actor.id,uuid:e},receiver:{id:a.id,cid:this.target.id,uuid:n}}).receiver.id!==game.user.id?t({...i,type:"trade-request"}):q(i),this.close()):u("templates.trade.no-user")}async#t(e){const t=$(e.currentTarget).siblings("input").val(),n=await fromUuid(t);n?.sheet.render(!0)}#e(e){const t=e.currentTarget.value;this.target=game.actors.get(t)}}async function L(e){e.preventDefault();const t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){const e=t.attr("data-uuid"),a=await A(e);if(!a)return;const i=await TextEditor.enrichHTML(a.description,{async:!0});n.find(".item-description").html(i),n.addClass("loaded")}t.toggleClass("expanded")}function N(e){e.preventDefault();const t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");const a=Number(n.attr("data-discard")??"0"),i=n.find(".action.discarded");n.toggleClass("discardable",i.length===a)}function R(){Object.values(ui.windows).forEach((e=>{e instanceof ActorSheet&&"character"===e.actor.type&&e.render(!0)}))}function F(e){switch(e.type){case"trade-reject":if(e.sender.id!==game.user.id)return;_(e);break;case"trade-accept":if(!function(){if(!game.user.isGM)return!1;const e=game.users.find((e=>e.active&&e.isGM));return game.user===e}())return;P(e);break;case"trade-request":if(e.receiver.id!==game.user.id)return;!async function(e){const{sender:n,receiver:a}=e,i=game.actors.get(n.cid),r=game.actors.get(a.cid);if(!i||!r)return void H(e);let o=`<p>${p("trade-request.header",{sender:i.name,receiver:r.name})}</p>`;o+=`<p>${p("trade-request.give",{give:h(n.uuid)})}</p>`,o+=`<p>${p("trade-request.want",{want:h(a.uuid)})}</p>`,o+=`<p style="margin-bottom: 1em;">${p("trade-request.accept")}</p>`,await Dialog.confirm({title:p("trade-request.title"),content:await TextEditor.enrichHTML(o,{async:!0})})?q(e):function(e){e.sender.id!==game.user.id?t({...e,type:"trade-reject"}):_(e)}(e)}(e);break;case"trade-error":if(!e.users.includes(game.user.id))return;x(e.error)}}e||(e="pf2e-hero-actions"),Hooks.on("renderCharacterSheetPF2e",(async function(e,t){const n=e.actor;!n.pack&&n.id&&game.actors.has(n.id)&&(await async function(e,t){const n=k(t),a=t.heroPoints.value-n.length,o=t.isOwner,c=g("templates.heroActions"),s=await renderTemplate(i("sheet.hbs"),{owner:o,list:n,canUse:a>=0&&o,canDraw:a>0&&o,canTrade:r("trade"),mustDiscard:a<0,diff:Math.abs(a),i18n:(e,{hash:t})=>c(e,t)});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(s)}(t,n),function(e,t){const n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",(e=>async function(e,t){t.preventDefault();const n=k(e),a=e.heroPoints.value-n.length,i=[];for(let e=0;e<a;e++){const e=await U();if(void 0!==e){if(null===e)return;n.push(e),i.push(e)}}if(!i.length)return;C(e,n);const r=i.map((e=>h(e.uuid,e.name)));ChatMessage.create({flavor:`<h4 class="action">${p("actions-draw.header",{nb:r.length})}</h4>`,content:r.map((e=>`<div>${e}</div>`)).join(""),speaker:ChatMessage.getSpeaker({actor:e})})}(t,e))),n.find("[data-action=expand]").on("click",L),n.find("[data-action=use]").on("click",(e=>async function(e,t){t.preventDefault();T(e,$(t.currentTarget).closest(".action").attr("data-uuid"))}(t,e))),n.find("[data-action=display]").on("click",(e=>async function(e,t){t.preventDefault();const n=$(t.currentTarget).closest(".action").attr("data-uuid"),a=await A(n);if(!a)return f("details.missing");ChatMessage.create({content:`<h2>${a.name}</h2>${a.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}(t,e))),n.find("[data-action=discard]").on("click",N),n.find("[data-action=discard-selected]").on("click",(()=>async function(e,t){const n=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map((e=>e.dataset.uuid)),a=k(e),i=[];for(const e of n){const t=a.findIndex((t=>t.uuid===e));-1!==t&&(i.push(a[t]),a.splice(t,1))}C(e,a);const r=i.map((e=>h(e.uuid,e.name)));ChatMessage.create({flavor:`<h4 class="action">${p("actions-discard.header",{nb:r.length})}</h4>`,content:r.map((e=>`<div>${e}</div>`)).join(""),speaker:ChatMessage.getSpeaker({actor:e})})}(t,e))),e.find("[data-action=hero-actions-trade]").on("click",(()=>function(e){const t=c(e,"heroActions");if(!t||!t.length)return void u("no-action");const n=t.length-e.heroPoints.value;n>0?u("no-points",{nb:n.toString()}):new Trade(e).render(!0)}(t)))}(t,n))})),Hooks.once("init",(()=>{o({name:"tableUUID",type:String,default:"",config:!0}),o({name:"trade",type:Boolean,default:!1,config:!0,onChange:R})})),Hooks.once("ready",(()=>{var t;t=F,game.socket.on(`module.${e}`,t),game.user.isGM&&((function(e){return game.modules.get(e)}(e)).api={createTable:E,removeHeroActions:j,getHeroActions:k,useHeroAction:T})}))})();
//# sourceMappingURL=main.js.map